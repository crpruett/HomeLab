apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana-agent
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      chart: grafana-agent
      version: 0.34.2 # Check latest in Grafana's chart repo
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  values:
    logs:
      enabled: true
      configs:
        - name: default
          clients:
            - url: http://loki.observability.svc.cluster.local:3100/loki/api/v1/push
          positions:
            filename: /tmp/positions.yaml
          scrape_configs:
            - job_name: kubernetes-pods
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                - source_labels: [__meta_kubernetes_pod_label_app]
                  target_label: app
                - action: replace
                  source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
              pipeline_stages:
                - docker: {}

